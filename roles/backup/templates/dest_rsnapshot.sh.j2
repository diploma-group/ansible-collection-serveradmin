#!/bin/bash
#
# Generated by Ansible
#
# Ändringar i denna fil ska göras via Ansible, annars skrivs de över. / Lasse
#

# Denna anropas från cron med $1 satt till något av följande: {{ backupinstance.dest.every | map(attribute='name') | join(', ') }}
{{ rsnapshot_bin_path.stdout | mandatory('rsnapshot_bin_path is missing') }} -c {{ backupinstance.rsnapshotfile }} "$1"

# Från loggen läs ut datum för senaste lyckade backupen.
# Detta ssh:as med kommandot "success" till den backupade servern.
# "success" är inget riktigt kommando utan tolkas i "validate-backup-cmd.sh"
# som sparar undan datumet i /opt/backup_source
# Där kan det senare läsas av scriptet <prefix>_list_backups

TIMESTAMP="$(grep "{{ backupinstance.dest.every[0].name }}: completed successfully" {{ backupinstance.dest.logfile }} | tail -1 | grep -oP "(?<=\[).{10,30}(?=\])" | sed "s/T/ /")"
# "
SIZE="$(du --summarize --human-readable "{{ backupinstance.dest.root }}/{{ backupinstance.name }}/{{ backupinstance.dest.every[0].name }}.0" | cut -f1)B"


/usr/bin/ssh {{ backup_info.source_user.name }}@{{ backup_info.ssh_host }} success "{{ backupinstance.name }}" "{{ backupinstance.dest.host }}" "$TIMESTAMP $SIZE"
